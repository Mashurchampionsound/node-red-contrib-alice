
<script type="text/javascript">
    RED.nodes.registerType('alice-service',{
        category: 'config',
        defaults: {
            name: {value:null}
        },
        credentials:{
            email: {type: "text", required:true},
            password: {type: "password", required:true},
            token: {type: "password", required:true},
            id:{type:"text",required:true}
        },
        label: function() {
            return this.name || "Alice-Credentials";
        },
        oneditprepare:function(){

        },
        oneditsave: function(){
            nodename = $('#node-config-input-email').val();
            $('#node-config-input-name').val(nodename);
        }
    });
    
    function GetToken(code){
        console.log(code);
        RED.notify("Request has been sent. Please, wait",{type:"compact"});
        $.ajax({
            url: "https://nodered-home.ru/api/v1/getyatoken",
            type:"POST",
            headers: {
                'Content-Type':'application/json'
            },
            crossDomain: true,
            contentType:"application/json",
            data: JSON.stringify({code:code}),
            dataType: "json",
            format:"json"
        })
        .done(data=>{
            console.log(data);
            RED.notify("Authentication received successfully", {type:"success"});
            $('#node-config-input-email').val(data.email).trigger("change");
            $('#node-config-input-id').val(data.id).trigger("input").trigger("change");
            $('#node-config-input-password').val(data.password).trigger("change");
            $('#node-config-input-token').val(JSON.stringify(data.token)).trigger("change");
        }).fail(error=>{
            console.error(error);
            RED.notify("Error : "+error.responseJSON.message, {type:"error"});
        });
    }
</script>

<script type="text/x-red" data-template-name="alice-service">    
    <input type="hidden" id="node-config-input-name">
    <div name="New Reg">
        <div class="form-row"><b>Credentials</b></div>
            <div class="form-row">
                <p>1. Follow the link and confirm access</p>
                <label>Authentication</label>
                <button 
                    onclick="window.open('https://oauth.yandex.ru/authorize?response_type=code&client_id=aa882e33283046fc83de54be20a2e5d8')"
                    class="ui-button">Yandex Authentication
                </button>
            </div>
            
            <div class="form-row">
                <p>2. Input the verification code and click submit</p>
                <label>Code</label>
                <input type="text" id="verification_code" style="width:auto">
                <button onclick="GetToken($('#verification_code').val())" class="ui-button">Submit</button>
            </div>
            <hr>
            <div class="form-row">
                <p>Authentication result:</p>
            </div>
            <div class="form-row">
                <label for="node-config-input-email">Email</label>
                <input type="text" id="node-config-input-email" disabled>
            </div>
            <div class="form-row">
                <label for="node-config-input-id">ID</label>
                <input type="text" id="node-config-input-id" disabled>
            </div>
            <div class="form-row">
                <label for="node-config-input-password">Password</label>
                <input type="password" id="node-config-input-password" disabled>
            </div>
            <div class="form-row">
                <label for="node-config-input-token">Token</label>
                <input type="password" id="node-config-input-token" disabled>
            </div>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('alice-device',{
        category: 'config',
        defaults:{
            service: {value:"", type:"alice-service"},
            name: {value:null, required: true},
            description: {value:null},
            room: {value:"Комната"},
            dtype: {value:"devices.types.light", required: true}
        },
        label: function(){
            return this.room+":"+this.name || "Alice-Device";
        }
    })
</script>

<script type="text/x-red" data-template-name="alice-device">
    <div class="form-row">
        <label for="node-config-input-service">Credentials</label>
        <input id="node-config-input-service">
    </div>
    <div class="form-row">
        <label for="node-config-input-name">Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-config-input-description">Description</label>
        <input type="text" id="node-config-input-description" placeholder="">
    </div>
    <div class="form-row">
        <label for="node-config-input-room">Room</label>
        <input type="text" id="node-config-input-room" placeholder="Room">
    </div>
    <div class="form-row">
        <label for="node-config-input-dtype">Type</label>
        <select id="node-config-input-dtype" style="width: 70%;">
            <option value="devices.types.light">Light</option>
            <option value="devices.types.socket">Socket</option>
            <option value="devices.types.switch" >Switch</option>
            <option value="devices.types.thermostat">Thermostat</option>
            <option value="devices.types.thermostat.ac">Air conditioning</option>
            <option value="devices.types.media_device">Multimedia</option>
            <option value="devices.types.media_device.tv">TV</option>
            <option value="devices.types.media_device.tv_box">TV Box</option>
            <option value="devices.types.media_device.receiver">AV Receiver</option>
            <option value="devices.types.cooking">Kitchen appliances</option>
            <option value="devices.types.cooking.coffee_maker">Coffee machine</option>
            <option value="devices.types.cooking.kettle">Smart kettle</option>
            <option value="devices.types.cooking.multicooker">Multicooker</option>
            <option value="devices.types.openable">Door, gate, window, shutters</option>
            <option value="devices.types.openable.curtain">Curtains, blinds</option>
            <option value="devices.types.humidifier">Humidifier</option>
            <option value="devices.types.purifier">Air purifier</option>
            <option value="devices.types.vacuum_cleaner">Vacuum cleaner robot</option>
            <option value="devices.types.washing_machine">Washing machine</option>
            <option value="devices.types.dishwasher">Dishwasher</option>
            <option value="devices.types.iron">Iron, steam generator</option>
            <option value="devices.types.sensor">Sensor</option>
            <option value="devices.types.other">Other</option>
        </select>
    </div>
</script>
